rm(list=ls())

# Chargement des librairies

library(tidyverse)

# lecture des données
data_file <- "raw_data/Bilan sonde penny maj_2020.xlsx"

stations <- readxl::read_xlsx(path = data_file, sheet = "Récaptitulatif ", range = "A1:I44") %>% 
  magrittr::set_colnames(c("station", "dept", "type_peche", "anodes", "dist_anode_cathode", "larg_moy", "prof_moy", "larg_mesure",
                           "prof_mesure"))

noms <- c("conductivite_25", "temp", "voltage", "puissance", "intensite", "penny_1m_c", "penny_1.5m_c", "penny_1.5m_b", "annee")

data_2020 <- readxl::read_xlsx(path = data_file, sheet = "Récaptitulatif ", range = "J1:P44") %>% 
  mutate(annee = 2020) %>% 
  rename("penny_1.5m_c" = "Penny à 1,5 m centre 2020",
         "penny_1.5m_b" = "Penny à 1,5 m bord 2020") %>% 
  mutate(penny_1m_c = NA) %>% 
  select(1:5, penny_1m_c, everything()) %>% 
  magrittr::set_names(noms) %>% 
  mutate(intensite = ifelse(is.na(intensite) & !is.na(voltage),
                            yes = 1000 * puissance / voltage,
                            no = intensite)) %>% 
  bind_cols(stations)


data_2019 <- readxl::read_xlsx(path = data_file, sheet = "Récaptitulatif ", range = "S1:Y44") %>% 
  mutate(annee = 2019) %>% 
  rename("penny_1.5m_c" = "Penny à 1,5m 2019",
         "penny_1m_c" = "Penny à 1 m 2019") %>% 
  mutate(penny_1.5m_b = NA) %>% 
  select(1:7, penny_1.5m_b, everything()) %>% 
  magrittr::set_names(noms) %>% 
  bind_cols(stations)


data_2018 <- readxl::read_xlsx(path = data_file, sheet = "Récaptitulatif ", range = "AB1:AH44") %>% 
  mutate(annee = 2018)%>% 
  rename("penny_1.5m_c" = "Penny à 1,5m 2018",
         "penny_1m_c" = "Penny à 1 m 2018") %>% 
  mutate(penny_1.5m_b = NA) %>% 
  select(1:7, penny_1.5m_b, everything()) %>% 
  magrittr::set_names(noms) %>% 
  bind_cols(stations)

data <- bind_rows(data_2018, data_2019, data_2020) %>% 
  select(station:prof_mesure, annee, everything()) %>% 
  mutate(cran = cut(voltage, breaks= c(0, 209, 241, 299, 331, 449, 471, 1000),
                    labels = c("NA", "2: 210-240V", "NA", "3: 300-330V", "NA", "4: 350-470V","NA")),
         cran = ifelse(cran == 'NA', NA, cran)) %>% 
  filter(!is.na(cran)) %>% 
  mutate(cran = as.factor(cran),
         conductivite = conductivite_25 / (1.023 ^ (25 - temp)), # Calcul de la cond in situ (celle affichée par le conductimètre est convertie en équivalente à 25°C)
         conductivite = round(conductivite))


rm(data_2018, data_2019, data_2020, stations, noms, data_file)

# Prétraitements

tableau_peches <- data %>% 
  mutate(intensite = round(intensite, digits = 2)) %>% 
  select(station, annee, cran, conductivite, conductivite_25, temp, voltage, puissance,
         intensite, penny_1m_c, penny_1.5m_c, penny_1.5m_b)

tableau_stations <- data %>% 
  select(station, dept, type_peche, anodes, dist_anode_cathode, larg_moy, larg_mesure, prof_moy, prof_mesure) %>% 
  unique()

# besoin de renommer pour avoir des intitulés courts qui rentrent dans la matrice + suppression lignes incomplètes
data_simp <- data %>%
  select(meth = type_peche, anodes, dist = dist_anode_cathode, lar_mo = larg_moy, pro_mo = prof_moy,
         pro_mo = prof_moy, pro_me = prof_mesure, annee, cond25 = conductivite_25, cond = conductivite,
         temp, volt = voltage, puiss = puissance, intens = intensite, pen1c = penny_1m_c,
         pen1.5c = penny_1.5m_c, pen1.5b = penny_1.5m_b, cran)

save(tableau_peches, tableau_stations, data, data_simp,
     file = "processed_data/donnees.RData")
