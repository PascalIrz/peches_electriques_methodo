---
title: "Mesures pêches électriques"
author: "OFB - DR Bretagne"
date: "29/04/2020"
output: word_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r packages}
library(tidyverse)
library(corrplot)
#library(wesanderson)
library(RColorBrewer)
library(ggthemr)
ggthemr("earth", type = "outer", layout = "scientific", spacing = 2)
```

```{r}
load(file = "../processed_data/penny_2.RData")
```


# Contexte et données

Afin d'objectiver les conditions dans lesquelles se déroulent les opérations de terrain ainsi que les réglages des appareils, des mesures ont été réalisées à l'occasion de pêches à l'électricité sur les cours d'eau de Bretagne et des Pays-de-la-Loire au cours des années 2018 et 2018. Ces opérations ont toutes été menées "en régie" par l'ex-AFB.

## Caractéristiques des stations pêchées

```{r}
tableau_stations %>% 
  DT::datatable(colnames = c("Station", "Dépt", "Type de pêche", "Anodes", "Distance anode cathode", "Largeur moyenne","Largeur mesure", "Profondeur moyenne", "Profondeur mesure"), rownames = FALSE)
```

## Les paramètres mesurés

Ces paramètres, mesurés pour chaque pêche, reflètent : 


* Des caractéristiques du milieu (conductivité de l'eau en $\mu S/cm$, température de l'eau en °C)  
* Le réglage de l'appareillage (Choix du cran sur le "Héron")   
* La résultante de l'interaction entre le milieu et l'appareil de pêche :  
    + Le champ créé par l'appareil sur le milieu, mesuré au moyen d'une sonde "Penny" placée à 1 ou 1,5m de la cathode et exprimé en V.m^-1^   
    + Les paramètres du courant électriques délivré (tension en V, intensité en A et puissance en kW)  
    
La conductivité et la température mesurées sur le terrain ont en outre été utilisées pour calculer la conductivité équivalente à 25°C, qui permet de caractériser les milieux indépendemment de la température au moment de la mesure. La conductivité $C_{25}$ est obtenue à partir de la température $t$ et de la conductivité à cette température $C_t$ par la formule de conversion suivante :

$C_{25} = \dfrac{C_t}{1 + 0,02 \times (t - 25)}$

Tableau des données brutes :

```{r}
tableau_peches %>% 
  DT::datatable(colnames = c("Station", "Année", "Cran", "Conductivité", "Conductivité à 25°C", "Température", "Voltage", "Puissance", "Intensité", "Penny à 1m", "Penny à 1,5m"), rownames = FALSE)
```

# Distribution des variables

On peut dans un premier temps examiner les valeurs prises par chacune des colonnes des tableaux.

Les graphiques ci-dessous sont réalisés sur l'ensemble des données des deux années. Les histogrammes de la colonne de droite sont représentés en transformation log.

>Nb : les valeurs moyennes sont indiquées en légende de l'axe horizontal et représentées par la ligne verticale en pointillés.

## Les stations


:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
graph_histo(x = "larg_moy", data = data, xlab = "Largeur moyenne (m)", type = "stations")
graph_histo(x = "prof_moy", data = data, xlab = "Profondeur moyenne (m)", type = "stations")
graph_histo(x = "dist_anode_cathode", data = data, xlab = "Distance anode cathode", type = "stations")
graph_histo(x = "larg_mesure", data = data, xlab = "Largeur au pt de mesure (m)", type = "stations")
graph_histo(x = "prof_mesure", data = data, xlab = "Profondeur au pt de mesure (m)", type = "stations")
```


:::

::: {}

```{r}
graph_histo(x = "larg_moy", data = data, xlab = "Largeur moyenne (m)", type = "stations") +
  scale_x_log10()
graph_histo(x = "prof_moy", data = data, xlab = "Profondeur moyenne (m)", type = "stations")+
  scale_x_log10()
graph_histo(x = "dist_anode_cathode", data = data, xlab = "Distance anode cathode", type = "stations")+
  scale_x_log10()
graph_histo(x = "larg_mesure", data = data, xlab = "Largeur au pt de mesure (m)", type = "stations")+
  scale_x_log10()
graph_histo(x = "prof_mesure", data = data, xlab = "Profondeur au pt de mesure (m)", type = "stations")+
  scale_x_log10()
```

:::

::::

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
graph_distri_var_qual(data = data, var_qual = "type_peche", var_qual_label = "Type de pêche",
                      type = "stations")
```


:::

::: {}

```{r}
graph_distri_var_qual(data = data, var_qual = "anodes", var_qual_label = "Nombre d'anodes",
                      type = "stations")
```

:::

::::


## Le milieu au moment des opérations

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
graph_histo(x = "conductivite", data = data, xlab = "Conductivité (\U00B5S/cm)", type = "pêches")
graph_histo(x = "temp", data = data, xlab = "Température", type = "pêches")
graph_histo(x = "conductivite_25", data = data, xlab = "Conductivité à 25°C(\U00B5S/cm)", type = "pêches")
```


:::

::: {}

```{r}
graph_histo(x = "conductivite", data = data, xlab = "Conductivité (\U00B5S/cm)", type = "pêches")+
  scale_x_log10()
graph_histo(x = "temp", data = data, xlab = "Température", type = "pêches")+
  scale_x_log10()
graph_histo(x = "conductivite_25", data = data, xlab = "Conductivité à 25°C(\U00B5S/cm)", type = "pêches")+
  scale_x_log10()
```

:::

::::

## Les opérations

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
graph_distri_var_qual(data = data, var_qual = "type_peche", var_qual_label = "Type de pêche",
                      type = "pêches")
```


:::

::: {}

```{r}
graph_distri_var_qual(data = data, var_qual = "cran", var_qual_label = "Cran de réglage du Héron",
                      type = "pêches")
```

:::

::::

## Interaction opération x milieu

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
graph_histo(x = "penny_1m", data = data, xlab = "Mesure Penny à 1m", type = "pêches")
graph_histo(x = "intensite", data = data, xlab = "Intensité", type = "pêches")
graph_histo(x = "voltage", data = data, xlab = "Voltage", type = "pêches")
graph_histo(x = "penny_1.5m", data = data, xlab = "Mesure Penny à 1,5m", type = "pêches")
graph_histo(x = "puissance", data = data, xlab = "Puissance", type = "pêches")
graph_distri_var_qual(data = data, var_qual = "cran", var_qual_label = "Cran de réglage du Héron",
                      type = "pêches")
```


:::

::: {}

```{r}
graph_histo(x = "penny_1m", data = data, xlab = "Mesure Penny à 1m", type = "pêches") +
  scale_x_log10()
graph_histo(x = "intensite", data = data, xlab = "Intensité", type = "pêches")+
  scale_x_log10()
graph_histo(x = "voltage", data = data, xlab = "Voltage", type = "pêches")+
  scale_x_log10()
graph_histo(x = "penny_1.5m", data = data, xlab = "Mesure Penny à 1,5m", type = "pêches")+
  scale_x_log10()
graph_histo(x = "puissance", data = data, xlab = "Puissance", type = "pêches")+
  scale_x_log10()
```

:::

::::


# Lien entre les variables

## Corrélations

### Vue d'ensemble

On peut s'interroger sur les liens entre les variables. Certains sont évidents. Par exemple la puissance ($P$, exprimée en Watts)est le produit du voltage ($U$, en volts) et de l'intensité ($I$, en ampères) :

$P(W)=U(V)\cdot I(A)$

Il ne serait donc pas surprenant que la puissance ait tendance à augmenter quand le voltage et l'intensité augmentent.

On peut aussi penser qu'il y a un lien entre les propriétés électriques du milieu (sa conductivité) et les réglages du matériel pour obtenir l'effet souhaité sur les poissons.

Pour y voir plus clair, il est possible de visualiser les corrélations entre les couples de variables.

Les représentations graphiques ci-dessous indiquent :

* Sous la diagonale, les coefficients de corrélation
* Au-dessus de la diagonale, les nuages de points résumés par des ellipses.  

Pour l'interprétation :

* Plus l'ellipse est de forme allongée, plus le lien entre les deux variables est fort.
* Plus le coefficient de corrélation est proche de 1 (corrélation positive) ou de -1 (corrélation négative), plus le lien entre les deux variables est fort.
* La couleur bleue indique des corrélations positives (quand la première variable augmente, la seconde augmente également) et le rouge les corrélations négatives (relation inverse).
* Les croix indiquent les relations statistiquement non significatives au seuil de 5%.

>NB : Comme les distributions ne sont pas toutes "gaussiennes", on emploie ici la corrélation de Spearman.

Sur l'ensemble des données on obtient :

```{r}
graph_corrplot(cor_tot, order = "hclust")
```

Lecture : Quand la température de l'eau est élevée, les paramètres de conductivité, puissance et intensité tendent à être élevés (corrélations entre +0,47 et +0,63) tandis que le voltage est plutôt faible (corrélation de -0,36). Un autre groupe de variables laisse apparaître que le voltage est les mesures Penny tendent à varier dans le même sens (corrélations positives significatives). Seul la variable voltage est commune à ces deux groupes, donc les mesures Penny ne sont corrélées qu'au voltage. 

Pour évaluer la constance des relations, on peut les comparer en subdivisant le jeu de données.

#### Comparaison entre années

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 25px; "}

::: {}
2018
```{r, fig.height = 8}
graph_corrplot(cor_2018, order = "original")
```
Le schéma pour l'année 2018 est cohérent avec le schéma général mais, le jeu de données étant restreint à une seule année de mesures, il y a moins de données donc moins de corrélations significatives.

:::

::: {}
2019
```{r, fig.height = 8}
graph_corrplot(cor_2019, order = "original")
```
Le schéma pour l'année 2019 est pratiquement identique au schéma général.

:::

::::

#### Comparaison selon le nombre d'anodes

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 1px; "}

::: {}
Une anode
```{r, fig.height = 8}
graph_corrplot(cor_1a, order = "original")
```
Le schéma pour une anode est pratiquement identique au schéma général.

:::

::: {}
Deux anodes
```{r, fig.height = 8}
graph_corrplot(cor_2a, order = "original")
```
Au sein des pêches à deux anodes, il est notable que la température n'est plus liée à aucun autre paramètre. On retrouve bien le groupe conductivité - intensité - puissance corrélées positivement et un autre groupe Penny - voltage. Plus surprenant, on observe une corrélation négative entre Cond25 et Penny à 1,5m (interprétation ?).

:::

::::

#### Comparaison selon le cran

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 1px; "}

::: {}
Cran 2
```{r, fig.height = 8}
graph_corrplot(cor_cran2, order = "original")
```
Au cran 2, les corrélations sont un peu différentes du schéma général. *Penny à 1,5m* n'est pas corrélée au voltage, en revanche *Penny 1m* est corrélée positivement à toutes les variables sauf au voltage. Interprétation ?

Cran 4
```{r, fig.height = 8}
graph_corrplot(cor_cran4, order = "original")
```
Au cran 4, on observe très peu de corrélations significatives. Il est possible que les données soient trop peu nombreuses.
:::

::: {}
Cran 3
```{r, fig.height = 8}
graph_corrplot(cor_cran3, order = "original")
```
Au cran 3, qui est le plus commun, les sens de corrélation (couleur des ellipses) sont cohérents avec le schéma général mais il avec moins de paires significatives.
:::

::::


#### Comparaison selon la méthode de pêche

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 1px; "}

::: {}
EPA Bateau
```{r, fig.height = 8}
graph_corrplot(cor_epa_bateau, order = "original")
```
Le schéma lors des prospections en bateau est assez différent du schéma général. Il y a peu de relations significatives, ce qui peut être lié au faible nombre des observations. On observe une forte corrélation négative entre voltage et *Penny 1m* (soit en sens inverse du schéma général certes avec une corrélation faible).

EPA à pieds
```{r, fig.height = 8}
graph_corrplot(cor_epa_pied, order = "original")
```
Pour les EPA à pieds, on retrouve le schéma général mais avec moins de relations significatives. Le groupe voltage n'est pas lié au groupe température - conductivité - puissance - intensité.


:::

::: {}
Inventaire
```{r, fig.height = 8}
graph_corrplot(cor_inv, order = "original")
```
Pour les pêches d'inventaire, on retrouve le schéma général sauf que la température n'est liée qu'à la conductivité.


:::

::::

### Relation Intensité - conductivité

Deux graphes sont produits :

* Pour l'intensité en fonction la conductivité observée sur le terrain
* Pour l'intensité en fonction la conductivité équivalente à 25°C 

```{r}
graph_intens_cond
graph_intens_cond_25
```

### Relation Penny - conductivité

```{r}
cond_penny_scatterplot
```



## Lien entre variables qualitatives et quantitatives

:::: {style="display: grid; grid-template-columns: 1fr 1fr 1fr; grid-column-gap: 10px; "}

::: {}

**Cran de réglage du Héron**

```{r}
graph_var_qual_var_quant(data = data,
                   var_quant = "voltage", var_quant_label = "Voltage (V)",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "puissance", var_quant_label = "Puissance (kW)",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "intensite", var_quant_label = "Intensité (A)",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "penny_1m", var_quant_label = "Mesure Penny à 1m",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "penny_1.5m", var_quant_label = "Mesure Penny à 1,5m",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "conductivite", var_quant_label = "Conductivité (\U00B5S/cm)",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "conductivite_25", var_quant_label = "Conductivité à 25°C (\U00B5S/cm)",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "temp", var_quant_label = "Température (°C)",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "dist_anode_cathode", var_quant_label = "Distance anode-cathode",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "larg_moy", var_quant_label = "Largeur moyenne (m)",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron") +
    scale_y_continuous(limits = quantile(data$larg_moy, c(0.05, 0.95), na.rm = T))

graph_var_qual_var_quant(data = data,
                   var_quant = "prof_moy", var_quant_label = "Profondeur moyenne (cm)",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron") +
    scale_y_continuous(limits = quantile(data$prof_moy, c(0.05, 0.95), na.rm = T))

graph_var_qual_var_quant(data = data,
                   var_quant = "larg_mesure", var_quant_label = "Largeur à la mesure (m)",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")

graph_var_qual_var_quant(data = data,
                   var_quant = "prof_mesure", var_quant_label = "Profondeur à la mesure",
                   var_qual = "cran", var_qual_label = "Cran de réglage du Héron")
```


:::

::: {}

**Type de pêche**

```{r}
graph_var_qual_var_quant(data = data,
                   var_quant = "voltage", var_quant_label = "Voltage (V)",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "puissance", var_quant_label = "Puissance (kW)",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "intensite", var_quant_label = "Intensité (A)",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "penny_1m", var_quant_label = "Mesure Penny à 1m",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "penny_1.5m", var_quant_label = "Mesure Penny à 1,5m",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "conductivite", var_quant_label = "Conductivité (\U00B5S/cm)",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "conductivite_25", var_quant_label = "Conductivité à 25°C (\U00B5S/cm)",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "temp", var_quant_label = "Température (°C)",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "dist_anode_cathode", var_quant_label = "Distance anode-cathode",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "larg_moy", var_quant_label = "Largeur moyenne (m)",
                   var_qual = "type_peche", var_qual_label = "Type de pêche") +
    scale_y_continuous(limits = quantile(data$larg_moy, c(0.05, 0.95), na.rm = T))

graph_var_qual_var_quant(data = data,
                   var_quant = "prof_moy", var_quant_label = "Profondeur moyenne (cm)",
                   var_qual = "type_peche", var_qual_label = "Type de pêche") +
    scale_y_continuous(limits = quantile(data$prof_moy, c(0.05, 0.95), na.rm = T))

graph_var_qual_var_quant(data = data,
                   var_quant = "larg_mesure", var_quant_label = "Largeur à la mesure (m)",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")

graph_var_qual_var_quant(data = data,
                   var_quant = "prof_mesure", var_quant_label = "Profondeur à la mesure",
                   var_qual = "type_peche", var_qual_label = "Type de pêche")
```

:::

::: {}

**Nombre d'anodes**

```{r}
graph_var_qual_var_quant(data = data,
                   var_quant = "voltage", var_quant_label = "Voltage (V)",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "puissance", var_quant_label = "Puissance (kW)",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "intensite", var_quant_label = "Intensité (A)",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "penny_1m", var_quant_label = "Mesure Penny à 1m",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "penny_1.5m", var_quant_label = "Mesure Penny à 1,5m",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "conductivite", var_quant_label = "Conductivité (\U00B5S/cm)",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "conductivite_25", var_quant_label = "Conductivité à 25°C (\U00B5S/cm)",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "temp", var_quant_label = "Température (°C)",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "dist_anode_cathode", var_quant_label = "Distance anode-cathode",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "larg_moy", var_quant_label = "Largeur moyenne (m)",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes") +
    scale_y_continuous(limits = quantile(data$larg_moy, c(0.05, 0.95), na.rm = T))

graph_var_qual_var_quant(data = data,
                   var_quant = "prof_moy", var_quant_label = "Profondeur moyenne (cm)",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes") +
  scale_y_continuous(limits = quantile(data$prof_moy, c(0.05, 0.95), na.rm = T))

graph_var_qual_var_quant(data = data,
                   var_quant = "larg_mesure", var_quant_label = "Largeur à la mesure (m)",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")

graph_var_qual_var_quant(data = data,
                   var_quant = "prof_mesure", var_quant_label = "Profondeur à la mesure",
                   var_qual = "anodes", var_qual_label = "Nombre d'anodes")
```

:::


::::


# Analyse des mesures Penny

## Comparaison des valeurs Penny à 1m et 1.5m

### Tableau des pourcentiles

#### Penny à 1m

```{r}
quantile_penny(data = data, penny = "penny_1m", penny_lab = "Mesure Penny à 1m (V)")
```

Lecture : 75% de ces mesures Penny à 1m sont inférieures à `r data %>% pull(penny_1m) %>% quantile(na.rm = TRUE) %>% .[4]`V.

#### Penny à 1,50m

```{r}
quantile_penny(data = data, penny = "penny_1.5m", penny_lab = "Mesure Penny à 1,5m (V)")
```

### Comparaison graphique des distributions

```{r}
comp_penny_plot
```

Les distributions des mesures Penny à 1m et 1,50m sont très différentes. Les valeurs sont plus élevées et beaucoup plus dispersées à 1m qu'à 1,50m. 

## Relations entre Penny 1m et 1,50m

Les graphiques ci-dessous visent à visualiser le lien entre les mesures Penny réalisées à 1m et à 1,50m. Les deux années de données sont représentées de couleur différente pour voir si la relation a varié entre 2018 et 2019. Les équations sur le graphiques sont complétées par le coefficient de détermination ($r^2$) et par la significaticité de la relation :

* (NS) : Non significative au seuil de 5%
* (*) : $0,05>p>0,01$
* (**) : $0,01>p>0,001$
* (***) : $p<0,001$

Cette convention sera conservée dans la suite du document.

```{r}
penny_1_1.5_scatterplot
```

Il apparaît que le lien est fort entre les mesures à 1m et à 1,50m malgré une certaine dispersion. Les équations sont très proches en 2018 et 2019. Une analyse de covariance montre qu'il n'existe pas de différence significative de la relation entre les deux années.

## Relation entre mesure Penny et les autres variables

De ce qui a été vu précédemment, il semble possible de ne plus retenir que la mesure Penny à 1,50m. Pour estimer si cette mesure est liée à d'autres variables, il est possible de modéliser cette mesure en fonction d'autres variables quantitatives. Les matrices de corrélation on sait qu'en corrélation de Spearma, il existe un lien avec le voltage.


```{r}
DT::datatable(tab_bivar_penny, caption = "a et b sont respectivement la pente et l'intercept de la relation", rownames = FALSE, colnames = c("Variable", "Pente", "Intercept", "p-value",  "r\U00B2", "Significativité"))
```

On a donc la confirmation d'un lien statistique entre la mesure Penny et le voltage, mais toutes les autres relations sont non significatives, y compris avec les descripteurs des stations (largeur, profondeur).

# Lien entre les valeurs d'une année sur l'autre ?

Les graphiques ci-dessous ont été réalisés en ne prenant en compte que les stations pour lesquelles les mesures avaient été réalisées en 2018 **et** en 2019. Ces stations sont au nombre de `r data_2ans %>% nrow()/2`.

Colonne de gauche : Chaque point représente une station. Sa couleur dépend du département. La droite en pointillés est celle pour laquelle les mesures en 2019 sont égales à celles en 2018. Les points au-dessus de la droite représentent des stations pour lesquelles la mesure en 2019 est plus forte que celle de 2018. A l'inverse, un point au-dessous de la droite montre que la station, la mesure en 2019 est inférieure à celle de 2018.

Colonne de droite : La hauteur des barres indique les valeurs moyennes du paramètre en 2018 et 2019. La moyenne générale est représentée par la fligen pointillée horizontale. Si les intervalles de confiance au sommet des barres "se chevauchent", il n'y a pas de différence entre les moyennes en 2018 et 2019. 

## Conductivité

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
comparer_annees_geom_point(df = data_2ans, variable = "conductivite")
```


:::

::: {}

```{r}
comparer_annees_geom_errorbar(df = data_2ans, variable = "conductivite")
```

:::

::::

## Voltage

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
comparer_annees_geom_point(df = data_2ans, variable = "voltage")
```


:::

::: {}

```{r}
comparer_annees_geom_errorbar(df = data_2ans, variable = "voltage")
```

:::

::::

## Puissance

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
comparer_annees_geom_point(df = data_2ans, variable = "puissance")
```


:::

::: {}

```{r}
comparer_annees_geom_errorbar(df = data_2ans, variable = "puissance")
```

:::

::::

## Intensité

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
comparer_annees_geom_point(df = data_2ans, variable = "intensite")
```


:::

::: {}

```{r}
comparer_annees_geom_errorbar(df = data_2ans, variable = "intensite")
```

:::

::::

## Mesure Penny à 1m

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
comparer_annees_geom_point(df = data_2ans, variable = "penny_1m")
```


:::

::: {}

```{r}
comparer_annees_geom_errorbar(df = data_2ans, variable = "penny_1m")
```

:::

::::

## Mesure Penny à 1,5m

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r}
comparer_annees_geom_point(df = data_2ans, variable = "penny_1.5m")
```


:::

::: {}

```{r}
comparer_annees_geom_errorbar(df = data_2ans, variable = "penny_1.5m")
```

:::

::::

## Cran de réglage

Pour les stations qui ont été prospectées en 2018 et en 2019, on peut croiser le cran de réglage en 2018 et celui en 2019 pour les placer dans un tableau croisé. Les valeurs dans le tableau représentent le nombre de stations pour chacune des combinaisons entre les 3 crans de réglage en 2018 et ceux en 2019, soit 9 cases. Le nombre total de stations qui ont été échantillonnées les deux années est de 22.

Si le réglage du cran restait constant d'une année sur l'autre, toutes les stations au cran 2 en 2018 seraient aussi au cran 2 en 2019 et ainsi de suite, donc toutes les valeurs non nulles du tableau seraient sur la diagonale. 

```{r}
xtab_cran
```

# Le cran de réglage en fonction des autres variables

La question est de savoir s'il est possible de prédire le cran de réglage du Héron à partir des caractéristiques du site (les variables explicatives). On ne peut pas retenir comme variables explicatives celles qui sont elles-mêmes dépendantes du réglage du Héron (mesure Penny, intensité, etc.) sans quoi le raisonnement est circulaire.
.
Les variables explicatives "candidates" sont donc les caractéristiques générales du milieu (profondeur, largeur) et les mesures prises in situ en l'absence du courant électrique provoqué par l'appareil (conductivité, température).

## Sélection des variables potentielles d'après les graphiques

Il est peu probable qu'une variable qui ne montre graphiquement aucun lien avec le cran ait un pouvoir explicatif. On commence donc par examiner les graphiques de la section \@ref(lien-entre-variables-qualitatives-et-quantitatives).

On relève que trois des variables semblent avoir des distributions différentes selon le cran de réglage : la température, la largeur moyenne de la rivière et la conductivité (on retient ici le paramètre conductivité à 25°C qui est celui mesuré sur le terrain).

Pour la modélisation, il faut que le tableau de données ne comporte pas de données manquantes.

```{r, echo = TRUE}
data_sel <- data %>% select(cran, larg_moy, conductivite_25, temp) %>%
  drop_na()
```

## Colinéarite ?

```{r, echo = TRUE}
data_sel %>%
  mutate(cran = as.numeric(as.character(cran))) %>%
  round(2) %>%
  cor()
```

Ce n'est pas trop mal $\Rightarrow$ on peut passer à l'étape de modélisation

## Modélisation

La variable que l'on cherche à prédire est le cran de réglage, qui peut prendre trois modalités (2, 3 ou 4) qui sont ordonnées. C'est une variable "ordinale". On utilisera donc un modèle de type régression logistique ordonnée avec le package {MASS}.

La démarche comprend les étapes suivantes :

* Construction de modèles complets avec différents paramétrages
* Conservation du "meilleur"
* Essai de simplification en retirant des variables explicatives si ça ne détériore pas le modèle

La qualité du modèle final sera évaluée par le pourcentage de pêches où le cran prédit par le modèle est celui qui a été employé sur le terrain. En toute rigueur il aurait été souhaitable de construire le modèle sur une partie des données et de le tester sur une autre partie, mais le nombre des observations étant limité, il aurait été dommage d'en écarter certaines pour élaborer le modèle.

La qualité des modèles intermédiaires sera évaluée sur le [critère d'Akaike (AIC)](https://fr.wikipedia.org/wiki/Crit%C3%A8re_d%27information_d%27Akaike). Plus sa valeur est faible, meilleur est l'ajustement.

### Tests du modèle complet

On commence par construire le modèle complet  (avec les 3 variables explicatives) en essayant plusieurs paramétrages (logistique, probit ...)

mod1 :

```{r}
mod1 <- MASS::polr(cran ~ larg_moy + conductivite_25 + temp, method = "logistic", data = data_sel)
summary(mod1, digits = 3)
```

mod2 :

```{r}
mod2 <- update(mod1, method = "probit", Hess = TRUE)
summary(mod2, digits = 3)
```

mod3 :

```{r}
mod3 <- update(mod1, method = "loglog", Hess = TRUE)
summary(mod3, digits = 3)
```

mod4 :

```{r}
mod4 <- update(mod1, method = "cloglog", Hess = TRUE)
summary(mod4, digits = 3)
```

D'après l'AIC on a de meilleurs résultats avec le modèle mod4 (AIC de 97,5).

### Pourcentage de bien classés

mod1 :

```{r}
pourcent_bien_classe <- function(table) {
  sum(diag(table)) / sum(table) * 100 %>% round(2)
}

table(predict(mod1, data_sel, type = "class"), data_sel$cran) %>% pourcent_bien_classe
```

mod2 :

```{r}

table(predict(mod2, data_sel, type = "class"), data_sel$cran) %>% pourcent_bien_classe

```

mod3 :

```{r}
table(predict(mod3, data_sel, type = "class"), data_sel$cran) %>% pourcent_bien_classe

```

mod4 :

```{r}
table(predict(mod4, data_sel, type = "class"), data_sel$cran) %>% pourcent_bien_classe
```

$\Rightarrow$ confirme que mod4 est meilleur en prédiction.

### Possibilité de le simplifier ?

```{r}
MASS::stepAIC(mod4)
```

$\Rightarrow$ si l'on veut retirer une variable c'est la largeur moyenne.

On construit donc le modèle mod5 : *cran ~ conductivite_25 + temp*

```{r, echo = TRUE}
mod5 <- MASS::polr(cran ~ conductivite_25 + temp, method = "cloglog", data = data_sel)
```

Taux de bien classés du mod5 sans *larg_moy* :

```{r}
table(predict(mod5, data_sel, type = "class"), data_sel$cran)  %>% pourcent_bien_classe
```

$\Rightarrow$ Le mod5 est aussi bon que le mod4 en prédiction, mais plus simple (seulement deux variables explicatives).

Possibilité d'encore simplifier ?

```{r}
MASS::stepAIC(mod5)
```

Essayons avec le modèle le plus simple (mod6) : *cran ~ conductivite_25*

Son taux de bien classé est :

```{r}
mod6 <- MASS::polr(cran ~ conductivite_25, method = "cloglog", data = data_sel)
table(predict(mod6, data_sel, type = "class"), data_sel$cran) %>% pourcent_bien_classe
```

Par rapport au mod5, c'est mieux en AIC mais moins bon en pourcentage de bien classé $\Rightarrow$ on garde de mod5 avec 64% de bien classés.

La matrice de confusion du modèle retenu est la suivante :

```{r}
mod_tab
```






